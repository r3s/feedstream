<!doctype html>
<html>
    <head>
        <title>FeedStream - Manage Feeds</title>
        <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
        <link
            rel="stylesheet"
            type="text/css"
            href="/static/css/normalize.css"
        />
        <link rel="stylesheet" type="text/css" href="/static/css/style.css" />
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>FeedStream - Manage Feeds</h1>
                <div>
                    <a href="/feeds" class="btn">View Feeds</a>
                    <a href="/feeds/add" class="btn">Add Feed</a>
                    <button id="theme-toggle" class="btn theme-toggle">🌙</button>
                    <a href="/logout" class="btn">Logout</a>
                </div>
            </div>

            <!-- Import/Export Section -->
            <div class="import-export-section">
                <form id="import-form" enctype="multipart/form-data" style="display: inline;">
                    <input type="file" id="feed-file" name="feedFile" accept=".json" style="margin-right: 10px;">
                    <button type="submit" style="margin-right: 10px;">Import Feeds</button>
                </form>
                <button id="export-btn" onclick="window.open('/feeds/export', '_blank')">Export Feeds</button>
            </div>

            {{if .}}
            <h2>Feeds</h2>
            <div class="feeds-table">
                {{range .}}
                <div class="feed-row">
                    <div class="feed-item-row">
                        <span class="feed-name">{{.Name}}</span>
                        <span class="feed-url">
                            <a href="{{.URL}}" target="_blank" rel="noopener"
                                >{{.URL}}</a
                            >
                        </span>
                    </div>
                    <div class="feed-meta">
                        <span class="feed-date"
                            >{{.CreatedAt.Format "Jan 2, 2006"}}</span
                        >
                        | <a href="/feeds/edit/{{.ID}}" class="btn">edit</a> |
                        <form
                            method="POST"
                            action="/feeds/delete/{{.ID}}"
                            style="display: inline"
                            onsubmit="return confirm('Are you sure you want to delete this feed? This will also delete all its articles.')"
                        >
                            <button type="submit" class="btn-delete">
                                delete
                            </button>
                        </form>
                    </div>
                </div>
                {{end}}
            </div>
            {{else}}
            <div class="empty-state">
                <h2>No feeds yet</h2>
                <p>
                    You haven't added any RSS feeds yet.
                    <a href="/feeds/add">Add your first feed</a> to get started.
                </p>
            </div>
            {{end}}
        </div>

        <script>
            // Theme toggle functionality
            function initThemeToggle() {
                const toggleBtn = document.getElementById('theme-toggle');
                const currentTheme = localStorage.getItem('theme') || 'light';
                
                // Apply saved theme
                if (currentTheme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    toggleBtn.textContent = '☀️';
                } else {
                    document.documentElement.removeAttribute('data-theme');
                    toggleBtn.textContent = '🌙';
                }
                
                // Toggle theme on click
                toggleBtn.addEventListener('click', function() {
                    const isDark = document.documentElement.hasAttribute('data-theme');
                    
                    if (isDark) {
                        document.documentElement.removeAttribute('data-theme');
                        localStorage.setItem('theme', 'light');
                        toggleBtn.textContent = '🌙';
                    } else {
                        document.documentElement.setAttribute('data-theme', 'dark');
                        localStorage.setItem('theme', 'dark');
                        toggleBtn.textContent = '☀️';
                    }
                });
            }

            // Initialize theme toggle
            initThemeToggle();

            // Import functionality
            document.getElementById('import-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const fileInput = document.getElementById('feed-file');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Please select a JSON file to import.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const feedData = JSON.parse(e.target.result);
                        
                        if (!feedData.feeds || !Array.isArray(feedData.feeds)) {
                            alert('Invalid JSON format. Expected a "feeds" array.');
                            return;
                        }
                        
                        // Send to server
                        fetch('/feeds/import', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(feedData)
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('Feeds imported successfully!');
                                location.reload();
                            } else {
                                alert('Error importing feeds: ' + (data.error || 'Unknown error'));
                            }
                        })
                        .catch(error => {
                            alert('Error importing feeds: ' + error.message);
                        });
                        
                    } catch (error) {
                        alert('Invalid JSON file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            });
        </script>
    </body>
</html>
